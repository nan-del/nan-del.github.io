<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="article">
<meta property="og:title" content="驱动学习">
<meta property="og:url" content="http://example.com/2021/09/22/%E9%A9%B1%E5%8A%A8%E5%AD%A6%E4%B9%A0/%E9%A9%B1%E5%8A%A8%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/09/26/LWnCPGMQeroptBT.png">
<meta property="og:image" content="https://i.loli.net/2021/10/09/WIpv92U5s6ZF18C.png">
<meta property="og:image" content="https://i.loli.net/2021/10/10/dZxmejBTLWE1lrG.png">
<meta property="og:image" content="https://i.loli.net/2021/10/10/TRtGhwkdZJbgWU8.png">
<meta property="og:image" content="https://i.loli.net/2021/10/10/P4yMorTctflASEV.png">
<meta property="og:image" content="https://i.loli.net/2021/10/10/WAPO9eFCya8iTmr.png">
<meta property="og:image" content="https://i.loli.net/2021/10/10/UzyPnpJesBXVtAj.png">
<meta property="og:image" content="https://i.loli.net/2021/10/10/92wXhoFRbkdgZQ5.png">
<meta property="og:image" content="https://i.loli.net/2021/10/10/Vk5EiSfsh8KwTJU.png">
<meta property="og:image" content="https://i.loli.net/2021/10/11/UjzyAca24IQq5Lv.png">
<meta property="og:image" content="https://i.loli.net/2021/10/11/9fToMld2OynA5mq.png">
<meta property="og:image" content="https://i.loli.net/2021/10/19/yJuqkjHosWt62AU.png">
<meta property="og:image" content="https://i.loli.net/2021/11/17/pDBNfxd8RZUQ2aV.png">
<meta property="og:image" content="https://i.loli.net/2021/11/20/YgvF9WrVJMfpK1s.png">
<meta property="og:image" content="https://i.loli.net/2021/11/20/efS7xwQMRZCnrzU.png">
<meta property="og:image" content="https://i.loli.net/2021/11/25/u3n4eEfds5Uz1CR.png">
<meta property="og:image" content="https://i.loli.net/2021/11/25/7SaZtxCgNnO4cyp.png">
<meta property="og:image" content="https://i.loli.net/2021/11/25/RP8pDgWXC5HrFqT.png">
<meta property="og:image" content="https://i.loli.net/2021/11/27/zdUXSCHE6WDoOLq.png">
<meta property="article:published_time" content="2021-09-22T12:51:44.000Z">
<meta property="article:modified_time" content="2021-11-27T15:26:53.285Z">
<meta property="article:author" content="nan-del">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/09/26/LWnCPGMQeroptBT.png">

<link rel="canonical" href="http://example.com/2021/09/22/%E9%A9%B1%E5%8A%A8%E5%AD%A6%E4%B9%A0/%E9%A9%B1%E5%8A%A8%E5%AD%A6%E4%B9%A0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>驱动学习 | Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/09/22/%E9%A9%B1%E5%8A%A8%E5%AD%A6%E4%B9%A0/%E9%A9%B1%E5%8A%A8%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="nan-del">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          驱动学习
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-22 20:51:44" itemprop="dateCreated datePublished" datetime="2021-09-22T20:51:44+08:00">2021-09-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-11-27 23:26:53" itemprop="dateModified" datetime="2021-11-27T23:26:53+08:00">2021-11-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><escape><span id="more"></span></escape></p>
<h2 id="编译驱动时的步骤"><a href="#编译驱动时的步骤" class="headerlink" title="编译驱动时的步骤"></a>编译驱动时的步骤</h2><ol>
<li>创建一个空的WDK的项目</li>
<li>在Source Files的文件夹中新建一个<code>.c</code>的文件</li>
<li>写代码</li>
<li>编译</li>
</ol>
<p>有几个新建项目时的报错问题</p>
<ol>
<li>调整<code>属性 - C/C++ - 常规</code>，警告等级 <strong>3</strong>，将警告视为错误 <strong>否</strong>；</li>
<li><code>链接器 - 常规</code>，警告视为错误 否；</li>
<li>如果遇到：<code>error 1297: Device driver does not install on any devices, use primitive driver if this is intended.</code> 说明是INF 文件是一个设备驱动程序，但它没有被用作设备驱动程序。这可能会导致驱动程序存储如何处理驱动程序的问题。所以要进行转。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">即把</span><br><span class="line">[Manufacturer]</span><br><span class="line">%ManufacturerName%=Standard,NT$ARCH$</span><br><span class="line"></span><br><span class="line">改为：</span><br><span class="line">[DefaultInstall.NT$ARCH$]</span><br><span class="line">CopyFiles=Drivers_Dir</span><br><span class="line">[Drivers_Dir]</span><br><span class="line">即可</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>如果遇到编译没有问题，但是一到虚拟机上运行就出错的话，可以先查看WDK对应的版本是否一致（如果是在win7上的话，下面的设置也要改为win7）</li>
</ol>
<p><img src="https://i.loli.net/2021/09/26/LWnCPGMQeroptBT.png" alt="image-20210926192952439"></p>
<p>​        </p>
<h2 id="注册表"><a href="#注册表" class="headerlink" title="注册表"></a>注册表</h2><p>注册表是Windows系统中重要的数据配置存储结构，存储着系统绝大部分的核心配置信息。注册表实际上也是一种文件，这些文件大多数存储在系统盘system32\config目录下。</p>
<p><strong>注册表的打开与关闭</strong></p>
<p>操作注册表都需要打开或者创建一个注册表键，可以使用ZwCreateKey函数；ZwCreateKey函数返回STATUS_SUCCESS则表示成功，否则返回一个错误码。</p>
<p>ZwCreateKey函数成功执行后，可以获得一个注册表键的句柄，我们可以通过这个句柄去操作（如删除、增加一个新键值）这个注册表。当这个句柄使用完毕后，需要对该句柄进行关闭，在内核中，关闭句柄都是使用一个函数ZwClose。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DbgPrint(<span class="string">&quot;This driver is unloading…,CurrentProcessId = 0x%p\n&quot;</span>,PsGetCurrentProcessId());</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//PUNICODE_STRING RegistryPath 驱动是以服务的形式加载的，这个RegistryPath指得是在注册表service的路径</span></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject,PUNICODE_STRING RegistryPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DbgPrint(<span class="string">&quot;This driver is loading…,CurrentProcessId = 0x%p\n&quot;</span>, PsGetCurrentProcessId());</span><br><span class="line">	OBJECT_ATTRIBUTES ObjAttr = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	HANDLE hkey = <span class="literal">NULL</span>;</span><br><span class="line">	ULONG ulDisposition = <span class="number">0</span>;</span><br><span class="line">	NTSTATUS nStatus = STATUS_SUCCESS;</span><br><span class="line">	UNREFERENCED_PARAMETER(DriverObject);</span><br><span class="line">	InitializeObjectAttributes(   <span class="comment">//这里是使用一个宏来初始化OBJECT_ATTRIBUTES结构体</span></span><br><span class="line">		&amp;ObjAttr,</span><br><span class="line">		RegistryPath,</span><br><span class="line">		OBJ_KERNEL_HANDLE | OBJ_CASE_INSENSITIVE,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	);</span><br><span class="line">	nStatus = ZwCreateKey(</span><br><span class="line">		&amp;hkey,  <span class="comment">//保存注册表键的句柄</span></span><br><span class="line">		KEY_WRITE, </span><br><span class="line">		&amp;ObjAttr,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		REG_OPTION_VOLATILE,  <span class="comment">//表示新建的注册表键在系统重启后不保留；REG_OPTION_NON_VOLATILE 表示新建的注册表键在系统重启后依旧保留</span></span><br><span class="line">		&amp;ulDisposition</span><br><span class="line">	);</span><br><span class="line">	<span class="keyword">if</span> (hkey != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;%p\n&quot;</span>, hkey);  <span class="comment">//这里打印了获得的句柄，即使是同一个程序，每一次重新执行的时候，获得的句柄都是不一样的</span></span><br><span class="line">		ZwClose(hkey);  <span class="comment">//这里使用完毕后，直接使用ZwClose关闭句柄</span></span><br><span class="line">		hkey = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	DbgPrint(<span class="string">&quot;%ws\n&quot;</span>, RegistryPath-&gt;Buffer);</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/10/09/WIpv92U5s6ZF18C.png" alt="image-20211009220220004"></p>
<p>当我们重启时吗，观察我们自己编写的驱动能否自动加载。</p>
<p><img src="https://i.loli.net/2021/10/10/dZxmejBTLWE1lrG.png" alt="image-20211010144158323"></p>
<p><img src="https://i.loli.net/2021/10/10/TRtGhwkdZJbgWU8.png" alt="image-20211010161100184"></p>
<p>可以看到即使重启之后，依然会加载出来，但是原本应该的情况是：重启之后，驱动不会自动加载，有可能的原因是xp的系统原因吧。</p>
<p>接下来试一试使用windows7看看怎么个情况：</p>
<p><img src="https://i.loli.net/2021/10/10/P4yMorTctflASEV.png" alt="image-20211010161429058"></p>
<p><img src="https://i.loli.net/2021/10/10/WAPO9eFCya8iTmr.png" alt="image-20211010161744097"></p>
<p> 可以看到在window7下重启系统后，没有看到之前加载我们的驱动。说明应该是系统的问题，在xp系统下，重启不会卸载我们的驱动。</p>
<p><strong>注册表的修改</strong></p>
<p>修改注册表的键值（VALUE）需要通过ZwSetValueKey函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DbgPrint(<span class="string">&quot;This driver is unloading…,CurrentProcessId = 0x%p\n&quot;</span>,PsGetCurrentProcessId());</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject,PUNICODE_STRING RegistryPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DbgPrint(<span class="string">&quot;This driver is loading…,CurrentProcessId = 0x%p\n&quot;</span>, PsGetCurrentProcessId());</span><br><span class="line">	OBJECT_ATTRIBUTES ObjAttr = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	HANDLE hkey = <span class="literal">NULL</span>;</span><br><span class="line">	ULONG ulDisposition = <span class="number">0</span>;</span><br><span class="line">	NTSTATUS nStatus = STATUS_SUCCESS;</span><br><span class="line">	UNREFERENCED_PARAMETER(DriverObject);</span><br><span class="line">	InitializeObjectAttributes(</span><br><span class="line">		&amp;ObjAttr,</span><br><span class="line">		RegistryPath,</span><br><span class="line">		OBJ_KERNEL_HANDLE | OBJ_CASE_INSENSITIVE,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	);</span><br><span class="line">	nStatus = ZwCreateKey(</span><br><span class="line">		&amp;hkey,</span><br><span class="line">		KEY_WRITE,</span><br><span class="line">		&amp;ObjAttr,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		REG_OPTION_VOLATILE,</span><br><span class="line">		&amp;ulDisposition</span><br><span class="line">	);</span><br><span class="line">	<span class="keyword">if</span> (hkey != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;%p\n&quot;</span>, hkey);   <span class="comment">// 打印程序打开的句柄</span></span><br><span class="line">		UNICODE_STRING usValueName = &#123; <span class="number">0</span> &#125;;  <span class="comment">// 初始化这个变量</span></span><br><span class="line">		ULONG ulNewStartValue = <span class="number">2</span>;</span><br><span class="line">		RtlInitUnicodeString(&amp;usValueName,<span class="string">L&quot;Start&quot;</span>);</span><br><span class="line">		nStatus = ZwSetValueKey(</span><br><span class="line">			hkey,   <span class="comment">// 表示需要修改的注册表键的句柄</span></span><br><span class="line">			&amp;usValueName,  <span class="comment">// 表示需要修改的注册表键值的名字</span></span><br><span class="line">			<span class="number">0</span>,</span><br><span class="line">			REG_DWORD,  <span class="comment">// 表示键值的类型，常见的类型有REG_BINARY(二进制类型)、REG_DWORD(双字类型)、REG_MULTI_SZ(多字符串类型)、REG_SZ(字符串类型)</span></span><br><span class="line">			(PVOID)&amp;ulNewStartValue,  <span class="comment">// 这个是一个PVOID指针，表示需要把改Data指向的数据写入到键值中</span></span><br><span class="line">			<span class="keyword">sizeof</span>(ulNewStartValue)</span><br><span class="line">		);</span><br><span class="line">		ZwClose(hkey);</span><br><span class="line">		hkey = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	DbgPrint(<span class="string">&quot;%ws\n&quot;</span>, RegistryPath-&gt;Buffer);</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码的作用是驱动程序加载后修改自身的启动方式为“自动启动”。下图是win7加载上面程序的驱动后重启依然可以看到我们的驱动。</p>
<p><img src="https://i.loli.net/2021/10/10/UzyPnpJesBXVtAj.png" alt="image-20211010162902311"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">原理：</span><br><span class="line">如果你的驱动是nt式驱动的话，也就是说，在注册表“HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services”下面，有一个你驱动的服务的话，这个服务下面有个“Start”的键，它取值0、1、2都代-表开机自启动，3代-表手动启动、4代-表禁止启动。一般取2就可以了，0和1时机太早，可能会失败。</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/10/10/92wXhoFRbkdgZQ5.png" alt="image-20211010163505558"></p>
<p><strong>注册表的读取</strong></p>
<p>我们可以使用ZwQueryValueKey函数读取注册表键值的内容。ZwQueryValueKey函数不仅可以查询指定键值的内容，还可以查询指定键值的类型、名字等。</p>
<p>与ZwSetValueKey函数不同，ZwQueryValueKey函数的返回值除了返回STATUS_SUCCES表示成功，还有两个重要的返回值需要关注：</p>
<p>STATUS_BUFFER_OVERFLOW：表示KeyValueInformation缓冲区太小，只有一部分键值的信息数据被复制到KeyValueInformation缓冲区。</p>
<p>STATUS_BUFFER_TOO_SMALL：表示KeyValueInformation缓冲区太小，没有任何信息数据被复制到KeyValueInformation缓冲区中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DbgPrint(<span class="string">&quot;This driver is unloading…,CurrentProcessId = 0x%p\n&quot;</span>, PsGetCurrentProcessId());</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DbgPrint(<span class="string">&quot;This driver is loading…,CurrentProcessId = 0x%p\n&quot;</span>, PsGetCurrentProcessId());</span><br><span class="line">	OBJECT_ATTRIBUTES ObjAttr = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	HANDLE hkey = <span class="literal">NULL</span>;</span><br><span class="line">	ULONG ulDisposition = <span class="number">0</span>;</span><br><span class="line">	NTSTATUS nStatus = STATUS_SUCCESS;</span><br><span class="line">	UNREFERENCED_PARAMETER(DriverObject);</span><br><span class="line">	InitializeObjectAttributes(</span><br><span class="line">		&amp;ObjAttr,</span><br><span class="line">		RegistryPath,</span><br><span class="line">		OBJ_KERNEL_HANDLE | OBJ_CASE_INSENSITIVE,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	);</span><br><span class="line">	nStatus = ZwCreateKey(</span><br><span class="line">		&amp;hkey,</span><br><span class="line">		KEY_WRITE,</span><br><span class="line">		&amp;ObjAttr,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		REG_OPTION_NON_VOLATILE,</span><br><span class="line">		&amp;ulDisposition</span><br><span class="line">	);</span><br><span class="line">	<span class="keyword">if</span> (hkey != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		UNICODE_STRING usValueName = &#123;<span class="number">0</span>&#125;; </span><br><span class="line">		ULONG  ulRetSize = <span class="number">0</span>;</span><br><span class="line">		RtlInitUnicodeString(&amp;usValueName,<span class="string">L&quot;Start&quot;</span>);</span><br><span class="line">		nStatus = ZwQueryValueKey(</span><br><span class="line">			hkey,</span><br><span class="line">			&amp;usValueName,</span><br><span class="line">			KeyValuePartialInformation,</span><br><span class="line">			<span class="literal">NULL</span>,</span><br><span class="line">			<span class="number">0</span>,</span><br><span class="line">			&amp;ulRetSize</span><br><span class="line">		);</span><br><span class="line">		<span class="keyword">if</span> (nStatus == STATUS_BUFFER_TOO_SMALL &amp;&amp; ulRetSize != <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//ulRetSize保存的是所需要获取的信息大小</span></span><br><span class="line">			ULONG ulStartValue = <span class="number">0</span>;</span><br><span class="line">			PKEY_VALUE_PARTIAL_INFORMATION pData = (PKEY_VALUE_PARTIAL_INFORMATION)</span><br><span class="line">			ExAllocatePoolWithTag(PagedPool, ulRetSize, <span class="string">&quot;DriF&quot;</span>);</span><br><span class="line">			<span class="keyword">if</span> (pData != <span class="literal">NULL</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">memset</span>(pData, <span class="number">0</span>, ulRetSize);</span><br><span class="line">				nStatus = ZwQueryValueKey(</span><br><span class="line">					hkey,  <span class="comment">// 需要被查询的注册表键句柄</span></span><br><span class="line">					&amp;usValueName,  <span class="comment">// 表示需要被查询的键值名字</span></span><br><span class="line">					KeyValuePartialInformation,  <span class="comment">// 这是一个枚举值，表示查询的类型，如果想查询键值的内容，可以传递KeyValueInformation;如果想查询键值所有的信息，可以传递KeyValueInformation</span></span><br><span class="line">					(PVOID)pData,  <span class="comment">// </span></span><br><span class="line">					ulRetSize,</span><br><span class="line">					&amp;ulRetSize  <span class="comment">// 原始是ResultLength,是一个返回参数，可以利用ResultLength以及STATUS_BUFFER_TOO_SMALL返回值获取当前所查询键值信息大小</span></span><br><span class="line">				);</span><br><span class="line">				<span class="keyword">if</span> (nStatus == STATUS_SUCCESS)</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">//获取Start的值</span></span><br><span class="line">					ulStartValue = *((ULONG*)pData-&gt;Data);</span><br><span class="line">					DbgPrint(<span class="string">&quot;Key:%wZ,ValueName:%wZ,Value:%u\n&quot;</span>, RegistryPath, &amp;usValueName, ulStartValue);</span><br><span class="line">				&#125;</span><br><span class="line">				ExFreePoolWithTag(pData, <span class="string">&quot;DriF&quot;</span>);</span><br><span class="line">				pData = <span class="literal">NULL</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ZwClose(hkey);</span><br><span class="line">		hkey = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	DbgPrint(<span class="string">&quot;%ws\n&quot;</span>, RegistryPath-&gt;Buffer);</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/10/10/Vk5EiSfsh8KwTJU.png" alt="image-20211010171635704"></p>
<p>这里我们使用的是xp系统，这里可以看到我们加载的驱动的信息，它的键值名为’Start’，它的值为2.所以之前的看到的自启动，是因为的他键值创建后就是2。（后面我把Start的键值改为3后，重新加载到xp中，重启后，果然没有自动加载）</p>
<h2 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h2><p><strong>文件的打开与关闭</strong></p>
<p>我们使用ZwCreateFile函数实现文件的打开，ZwClose函数 实现文件的关闭。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DbgPrint(<span class="string">&quot;This driver is unloading…,CurrentProcessId = 0x%p\n&quot;</span>, PsGetCurrentProcessId());</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DbgPrint(<span class="string">&quot;This driver is loading…,CurrentProcessId = 0x%p\n&quot;</span>, PsGetCurrentProcessId());</span><br><span class="line">	HANDLE file_handle = <span class="literal">NULL</span>;</span><br><span class="line">	NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">	IO_STATUS_BLOCK io_status;</span><br><span class="line">	OBJECT_ATTRIBUTES object_attributes;</span><br><span class="line">	UNICODE_STRING ufile_name = RTL_CONSTANT_STRING(<span class="string">L&quot;\\??\\c:\\a.txt&quot;</span>);  <span class="comment">//这是文件的路径</span></span><br><span class="line">    <span class="comment">// 值得注意的是路径的写法，并不是像应用层一样直接写“C:\\a.txt”，而是写成了“\\??\\c:\\a.txt”。这是因为ZwCreateFile使用的是对象路径，“C:”是一个符号链接对象，符号链接对象一般在“\\??\\”路径下。</span></span><br><span class="line">	InitializeObjectAttributes(</span><br><span class="line">		&amp;object_attributes,</span><br><span class="line">		&amp;ufile_name,</span><br><span class="line">		OBJ_KERNEL_HANDLE | OBJ_CASE_INSENSITIVE,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	);</span><br><span class="line">	status = ZwCreateFile(</span><br><span class="line">		&amp;file_handle,</span><br><span class="line">		GENERIC_READ | GENERIC_WRITE,</span><br><span class="line">		&amp;object_attributes,</span><br><span class="line">		&amp;io_status,  <span class="comment">// 这一步，书上没有定义，应该在上面的时候就定义，即应多加IO_STATUS_BLOCK io_status; 不然编译不了</span></span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">		FILE_SHARE_READ,</span><br><span class="line">		FILE_OPEN_IF,</span><br><span class="line">		FILE_NON_DIRECTORY_FILE | FILE_RANDOM_ACCESS | FILE_SYNCHRONOUS_IO_ALERT,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		<span class="number">0</span></span><br><span class="line">	);</span><br><span class="line">	DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	DbgPrint(<span class="string">&quot;%ws\n&quot;</span>, RegistryPath-&gt;Buffer);</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/10/11/UjzyAca24IQq5Lv.png" alt="image-20211011212337857"></p>
<p><img src="https://i.loli.net/2021/10/11/9fToMld2OynA5mq.png" alt="image-20211011212443431"></p>
<p>即使卸载了驱动，但是还是删除不了我们创建的文件。只有删除驱动并重新启动才可以删除创建的文件。上述的前提是没有使用ZwClose这个函数。只要在程序的末尾使用了<code>ZwClose(file_handle);</code>，那么就可以随时删除驱动生成的文件，不需要卸载驱动并重启这么麻烦了。</p>
<p><strong>文件的读写</strong></p>
<p>读与写的方法是对称的，只是参数输入与输出的方向不同。读取文件内容一般使用ZwReadFile,写文件一般使用ZwWriteFile。只有读和写的函数，没有拷贝的函数。需要我们自己写（其实也就是读和写的结合–即下面的FileOption函数，它是先创建source.txt并写入文本，在复制一份target.txt，也就相当于拷贝了）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DbgPrint(<span class="string">&quot;This driver is unloading…,CurrentProcessId = 0x%p\n&quot;</span>, PsGetCurrentProcessId());</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">VOID <span class="title">FileOption</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HANDLE SourceFileHandle = <span class="literal">NULL</span>;      <span class="comment">//源文件句柄</span></span><br><span class="line">    HANDLE TargetFileHandle = <span class="literal">NULL</span>;      <span class="comment">//目标文件句柄</span></span><br><span class="line">    NTSTATUS Status = STATUS_SUCCESS;    <span class="comment">//返回状态</span></span><br><span class="line">    OBJECT_ATTRIBUTES ObjectAttributes;  <span class="comment">//OBJECT_ATTRIBUTES结构</span></span><br><span class="line">    UNICODE_STRING SourceFilePath = RTL_CONSTANT_STRING(<span class="string">L&quot;\\??\\c:\\source.txt&quot;</span>); <span class="comment">//源文件</span></span><br><span class="line">    UNICODE_STRING TargetFilePath = RTL_CONSTANT_STRING(<span class="string">L&quot;\\??\\c:\\target.txt&quot;</span>); <span class="comment">//目标文件</span></span><br><span class="line">    UNICODE_STRING String = &#123; <span class="number">0</span> &#125;;           <span class="comment">//指向Buffer</span></span><br><span class="line">    IO_STATUS_BLOCK IoStatusBlock;         <span class="comment">//返回结果状态结构体</span></span><br><span class="line">    PVOID Buffer = <span class="literal">NULL</span>;                   <span class="comment">//buffer指针</span></span><br><span class="line">    USHORT Length = <span class="number">0</span>;                     <span class="comment">//要读写的长度</span></span><br><span class="line">    LARGE_INTEGER Offset = &#123; <span class="number">0</span> &#125;;            <span class="comment">//要读写的偏移</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化OBJECT_ATTRIBUTES结构体</span></span><br><span class="line">    InitializeObjectAttributes(</span><br><span class="line">        &amp;ObjectAttributes,</span><br><span class="line">        &amp;SourceFilePath,</span><br><span class="line">        OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//以FILE_OVERWRITE_IF方式打开</span></span><br><span class="line">    Status = ZwCreateFile(</span><br><span class="line">        &amp;SourceFileHandle,</span><br><span class="line">        GENERIC_READ | GENERIC_WRITE | SYNCHRONIZE,</span><br><span class="line">        &amp;ObjectAttributes,</span><br><span class="line">        &amp;IoStatusBlock,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">        FILE_SHARE_READ,</span><br><span class="line">        FILE_OVERWRITE_IF,</span><br><span class="line">        FILE_NON_DIRECTORY_FILE |</span><br><span class="line">        FILE_RANDOM_ACCESS |</span><br><span class="line">        FILE_SYNCHRONOUS_IO_NONALERT,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(Status))</span><br><span class="line">    &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;Open source file fault !! - %#x\n&quot;</span>, Status);</span><br><span class="line">        <span class="keyword">return</span> Status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//字符串操作</span></span><br><span class="line">    <span class="comment">//动态申请内存</span></span><br><span class="line">    Buffer = (PWCHAR)ExAllocatePoolWithTag(NonPagedPool, <span class="number">1024</span>, <span class="string">&#x27;Tag1&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == Buffer)</span><br><span class="line">    &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;申请Buffer失败!!\n&quot;</span>);</span><br><span class="line">        ZwClose(SourceFileHandle);</span><br><span class="line">        Status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">        <span class="keyword">return</span> Status;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//初始化字符串指针</span></span><br><span class="line">    RtlInitEmptyUnicodeString(&amp;String, Buffer, <span class="number">512</span> * <span class="keyword">sizeof</span>(WCHAR));</span><br><span class="line">    <span class="comment">//拷贝字符串</span></span><br><span class="line">    <span class="comment">//RtlCopyUnicodeString(&amp;String, &amp;SourceFilePath);</span></span><br><span class="line">    <span class="comment">//追加Unicode变量</span></span><br><span class="line">    <span class="comment">//RtlAppendUnicodeStringToString(&amp;String, &amp;TargetFilePath);</span></span><br><span class="line">    <span class="comment">//追加字符串</span></span><br><span class="line">    <span class="comment">//RtlAppendUnicodeToString(&amp;String, L&quot;hello world&quot;);</span></span><br><span class="line">    RtlAppendUnicodeToString(&amp;String, <span class="string">L&quot;  你好&quot;</span>);  <span class="comment">// 这里如果是汉字的话需要空格，不然就会有乱码，如果是英文就没有影响，至于为什么和怎么解决，还不清楚。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//写入文件</span></span><br><span class="line">    Length = String.Length;</span><br><span class="line">    Offset.QuadPart = <span class="number">0</span>;</span><br><span class="line">    Status = ZwWriteFile(</span><br><span class="line">        SourceFileHandle,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;IoStatusBlock,</span><br><span class="line">        Buffer,</span><br><span class="line">        Length,</span><br><span class="line">        &amp;Offset,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(Status))</span><br><span class="line">    &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;写入源文件失败!!\n - %#X&quot;</span>, Status);</span><br><span class="line">        ZwClose(SourceFileHandle);</span><br><span class="line">        ExFreePool(Buffer);</span><br><span class="line">        <span class="keyword">return</span> Status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化OBJECT_ATTRIBUTES结构体</span></span><br><span class="line">    InitializeObjectAttributes(</span><br><span class="line">        &amp;ObjectAttributes,</span><br><span class="line">        &amp;TargetFilePath,</span><br><span class="line">        OBJ_CASE_INSENSITIVE | OBJ_KERNEL_HANDLE,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//打开目标文件</span></span><br><span class="line">    Status = ZwCreateFile(</span><br><span class="line">        &amp;TargetFileHandle,</span><br><span class="line">        GENERIC_READ | GENERIC_WRITE | SYNCHRONIZE,</span><br><span class="line">        &amp;ObjectAttributes,</span><br><span class="line">        &amp;IoStatusBlock,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        FILE_OVERWRITE_IF,</span><br><span class="line">        FILE_NON_DIRECTORY_FILE |</span><br><span class="line">        FILE_RANDOM_ACCESS |</span><br><span class="line">        FILE_SYNCHRONOUS_IO_NONALERT,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (!NT_SUCCESS(Status))</span><br><span class="line">    &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;目标文件打开失败!! - %#X&quot;</span>, Status);</span><br><span class="line">        ZwClose(SourceFileHandle);</span><br><span class="line">        ExFreePool(Buffer);</span><br><span class="line">        <span class="keyword">return</span> Status;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化文件指针并循环复制文件,每次复制一个字节</span></span><br><span class="line">    Offset.QuadPart = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//读取源文件</span></span><br><span class="line">        Status = ZwReadFile(</span><br><span class="line">            SourceFileHandle,</span><br><span class="line">            <span class="literal">NULL</span>,</span><br><span class="line">            <span class="literal">NULL</span>,</span><br><span class="line">            <span class="literal">NULL</span>,</span><br><span class="line">            &amp;IoStatusBlock,</span><br><span class="line">            Buffer,</span><br><span class="line">            <span class="number">1</span>,</span><br><span class="line">            &amp;Offset,</span><br><span class="line">            <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (!NT_SUCCESS(Status))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (STATUS_END_OF_FILE == <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Status = STATUS_SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//写入目标文件</span></span><br><span class="line">        Status = ZwWriteFile(</span><br><span class="line">            TargetFileHandle,</span><br><span class="line">            <span class="literal">NULL</span>,</span><br><span class="line">            <span class="literal">NULL</span>,</span><br><span class="line">            <span class="literal">NULL</span>,</span><br><span class="line">            &amp;IoStatusBlock,</span><br><span class="line">            Buffer,</span><br><span class="line">            <span class="number">1</span>,</span><br><span class="line">            &amp;Offset,</span><br><span class="line">            <span class="literal">NULL</span>);</span><br><span class="line">        Offset.QuadPart += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//释放指针,释放申请的内存</span></span><br><span class="line">    ZwClose(SourceFileHandle);</span><br><span class="line">    ZwClose(TargetFileHandle);</span><br><span class="line">    ExFreePool(Buffer);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FileOption();</span><br><span class="line">    DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">    DbgPrint(<span class="string">&quot;%ws\n&quot;</span>, RegistryPath-&gt;Buffer);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/10/19/yJuqkjHosWt62AU.png" alt="image-20211019170714235"></p>
<p>下面的是《Windows内核编程》里的代码，但是有问题，运行不了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverUnload</span><span class="params">(PDRIVER_OBJECT DriverObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DbgPrint(<span class="string">&quot;This driver is unloading…,CurrentProcessId = 0x%p\n&quot;</span>, PsGetCurrentProcessId());</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DbgPrint(<span class="string">&quot;This driver is loading…,CurrentProcessId = 0x%p\n&quot;</span>, PsGetCurrentProcessId());</span><br><span class="line">	HANDLE file_handle = <span class="literal">NULL</span>;</span><br><span class="line">	NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">	IO_STATUS_BLOCK io_status;</span><br><span class="line">    UNICODE_STRING String = &#123; <span class="number">0</span> &#125;;           <span class="comment">//指向Buffer</span></span><br><span class="line">	OBJECT_ATTRIBUTES object_attributes;</span><br><span class="line">	PVOID Buffer = <span class="literal">NULL</span>;                   <span class="comment">//buffer指针</span></span><br><span class="line">	USHORT Length = <span class="number">0</span>;                     <span class="comment">//要读写的长度</span></span><br><span class="line">	LARGE_INTEGER Offset = &#123; <span class="number">0</span> &#125;;            <span class="comment">//要读写的偏移</span></span><br><span class="line">	UNICODE_STRING ufile_name = RTL_CONSTANT_STRING(<span class="string">L&quot;\\??\\c:\\b.txt&quot;</span>);  <span class="comment">//这是文件的路径</span></span><br><span class="line">	<span class="comment">// 值得注意的是路径的写法，并不是像应用层一样直接写“C:\\a.txt”，而是写成了“\\??\\c:\\a.txt”。这是因为ZwCreateFile使用的是对象路径，“C:”是一个符号链接对象，符号链接对象一般在“\\??\\”路径下。</span></span><br><span class="line">	InitializeObjectAttributes(</span><br><span class="line">		&amp;object_attributes,</span><br><span class="line">		&amp;ufile_name,</span><br><span class="line">		OBJ_KERNEL_HANDLE | OBJ_CASE_INSENSITIVE,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	);</span><br><span class="line">	status = ZwCreateFile(</span><br><span class="line">		&amp;file_handle,</span><br><span class="line">		GENERIC_READ | GENERIC_WRITE,</span><br><span class="line">		&amp;object_attributes,</span><br><span class="line">		&amp;io_status,  <span class="comment">// 这一步，书上没有定义，应该在上面的时候就定义，即应多加IO_STATUS_BLOCK io_status; 不然编译不了</span></span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">		FILE_SHARE_READ,</span><br><span class="line">		FILE_OPEN_IF,</span><br><span class="line">		FILE_NON_DIRECTORY_FILE | FILE_RANDOM_ACCESS | FILE_SYNCHRONOUS_IO_ALERT,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		<span class="number">0</span></span><br><span class="line">	);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//字符串操作</span></span><br><span class="line">    <span class="comment">//动态申请内存</span></span><br><span class="line">    Buffer = (PWCHAR)ExAllocatePoolWithTag(NonPagedPool, <span class="number">1024</span>, <span class="string">&#x27;Tag1&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">NULL</span> == Buffer)</span><br><span class="line">    &#123;</span><br><span class="line">        DbgPrint(<span class="string">&quot;申请Buffer失败!!\n&quot;</span>);</span><br><span class="line">        ZwClose(file_handle);</span><br><span class="line">        status = STATUS_INSUFFICIENT_RESOURCES;</span><br><span class="line">        <span class="keyword">return</span> status;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//初始化字符串指针</span></span><br><span class="line">    <span class="comment">//RtlInitEmptyUnicodeString(&amp;String, Buffer, 512 * sizeof(WCHAR));</span></span><br><span class="line">    <span class="comment">//拷贝字符串</span></span><br><span class="line">   <span class="comment">// RtlCopyUnicodeString(&amp;String, &amp;file_handle);</span></span><br><span class="line">    <span class="comment">//追加字符串</span></span><br><span class="line">    <span class="comment">//RtlAppendUnicodeToString(&amp;String, L&quot;别问我这是啥&quot;);</span></span><br><span class="line">    <span class="comment">//RtlAppendUnicodeToString(&amp;String, L&quot;hello word&quot;);</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//WCHAR conTwo[20] = L&quot;hello world!&quot;;</span></span><br><span class="line">	WCHAR conTwo[<span class="number">20</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//写入文件</span></span><br><span class="line">    Length = String.Length;</span><br><span class="line">    Offset.QuadPart = <span class="number">0</span>;</span><br><span class="line">    status = ZwWriteFile(</span><br><span class="line">        file_handle,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        &amp;io_status,</span><br><span class="line">		conTwo,</span><br><span class="line">		<span class="number">4</span> * <span class="keyword">sizeof</span>(WCHAR),</span><br><span class="line">        &amp;Offset,</span><br><span class="line">        <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">	ZwClose(file_handle);</span><br><span class="line">	DbgPrint(<span class="string">&quot;%ws\n&quot;</span>, RegistryPath-&gt;Buffer);</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="线程与事件"><a href="#线程与事件" class="headerlink" title="线程与事件"></a>线程与事件</h2><p><strong>使用系统线程</strong></p>
<p>在驱动中停止等待很容易使整个系统陷入“停顿”，最后可能只能重启电脑。但一个单独的线程长期等待，还不至于对系统造成致命的影响。还有一些任务是希望长期、不断执行的，比如不断地写入日志，为此启动一个特殊的线程来执行是最好的方法。在驱动中生成的线程一般是系统线程，系统线程所在的进程名为“System”。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdafxx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> a;</span><br><span class="line"><span class="keyword">int</span> _tmain(<span class="keyword">int</span> argc,_TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	HANDLE hDevice = CreateFile(</span><br><span class="line">		<span class="string">L&quot;\\\.\\MyRead&quot;</span>,</span><br><span class="line">		GENERIC_READ | GENERIC_WRITE,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		OPEN_EXISTING,</span><br><span class="line">		FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">		);</span><br><span class="line">	<span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Failed to obtain handle to device:&quot;</span></span><br><span class="line">			<span class="string">&quot;%s with Win32 error code: %d\n&quot;</span>,</span><br><span class="line">			<span class="string">&quot;MyWDMDevice&quot;</span>, GetLastError()</span><br><span class="line">		);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	UCHAR buffer[<span class="number">10</span>];</span><br><span class="line">	ULONG ulRead;</span><br><span class="line">	BOOL bRet = ReadFile(hDevice, buffer, <span class="number">10</span>, &amp;ulRead, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (bRet)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Read %d bytes:&quot;</span>, ulRead);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (<span class="keyword">int</span>)ulRead; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%02X&quot;</span>, buffer[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	CloseHandle(hDevice);</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;a);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="串口的过滤"><a href="#串口的过滤" class="headerlink" title="串口的过滤"></a>串口的过滤</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NTSTRSAFE_LIB</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntstrsafe.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> SetFlag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SetFlag(_F,_SF)       ((_F) |= (_SF))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ClearFlag</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ClearFlag(_F,_SF)     ((_F) &amp;= ~(_SF))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CCP_MAX_COM_ID 32</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 过滤设备和真实设备</span></span><br><span class="line"><span class="keyword">static</span> PDEVICE_OBJECT s_fltobj[CCP_MAX_COM_ID] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"><span class="keyword">static</span> PDEVICE_OBJECT s_nextobj[CCP_MAX_COM_ID] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 打开一个端口设备</span></span><br><span class="line"><span class="function">PDEVICE_OBJECT <span class="title">ccpOpenCom</span><span class="params">(ULONG id, NTSTATUS* status)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UNICODE_STRING name_str;</span><br><span class="line">	<span class="keyword">static</span> WCHAR name[<span class="number">32</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	PFILE_OBJECT fileobj = <span class="literal">NULL</span>;</span><br><span class="line">	PDEVICE_OBJECT devobj = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 输入字符串。</span></span><br><span class="line">	<span class="built_in">memset</span>(name, <span class="number">0</span>, <span class="keyword">sizeof</span>(WCHAR) * <span class="number">32</span>);</span><br><span class="line">	RtlStringCchPrintfW(</span><br><span class="line">		name, <span class="number">32</span>,</span><br><span class="line">		<span class="string">L&quot;\\Device\\Serial%d&quot;</span>, id);</span><br><span class="line">	RtlInitUnicodeString(&amp;name_str, name);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 打开设备对象</span></span><br><span class="line">	*status = IoGetDeviceObjectPointer(&amp;name_str, FILE_ALL_ACCESS, &amp;fileobj, &amp;devobj);</span><br><span class="line">	<span class="keyword">if</span> (*status == STATUS_SUCCESS)</span><br><span class="line">		ObDereferenceObject(fileobj);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> devobj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS</span></span><br><span class="line"><span class="function"><span class="title">ccpAttachDevice</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">	PDRIVER_OBJECT driver,</span></span></span><br><span class="line"><span class="params"><span class="function">	PDEVICE_OBJECT oldobj,</span></span></span><br><span class="line"><span class="params"><span class="function">	PDEVICE_OBJECT* fltobj,</span></span></span><br><span class="line"><span class="params"><span class="function">	PDEVICE_OBJECT* next)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	NTSTATUS status;</span><br><span class="line">	PDEVICE_OBJECT topdev = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 生成设备，然后绑定之。</span></span><br><span class="line">	status = IoCreateDevice(driver,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		oldobj-&gt;DeviceType,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		FALSE,</span><br><span class="line">		fltobj);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (status != STATUS_SUCCESS)</span><br><span class="line">		<span class="keyword">return</span> status;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 拷贝重要标志位。</span></span><br><span class="line">	<span class="keyword">if</span> (oldobj-&gt;Flags &amp; DO_BUFFERED_IO)</span><br><span class="line">		(*fltobj)-&gt;Flags |= DO_BUFFERED_IO;</span><br><span class="line">	<span class="keyword">if</span> (oldobj-&gt;Flags &amp; DO_DIRECT_IO)</span><br><span class="line">		(*fltobj)-&gt;Flags |= DO_DIRECT_IO;</span><br><span class="line">	<span class="keyword">if</span> (oldobj-&gt;Flags &amp; DO_BUFFERED_IO)</span><br><span class="line">		(*fltobj)-&gt;Flags |= DO_BUFFERED_IO;</span><br><span class="line">	<span class="keyword">if</span> (oldobj-&gt;Characteristics &amp; FILE_DEVICE_SECURE_OPEN)</span><br><span class="line">		(*fltobj)-&gt;Characteristics |= FILE_DEVICE_SECURE_OPEN;</span><br><span class="line">	(*fltobj)-&gt;Flags |= DO_POWER_PAGABLE;</span><br><span class="line">	<span class="comment">// 绑定一个设备到另一个设备上</span></span><br><span class="line">	topdev = IoAttachDeviceToDeviceStack(*fltobj, oldobj);</span><br><span class="line">	<span class="keyword">if</span> (topdev == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 如果绑定失败了，销毁设备，重新来过。</span></span><br><span class="line">		IoDeleteDevice(*fltobj);</span><br><span class="line">		*fltobj = <span class="literal">NULL</span>;</span><br><span class="line">		status = STATUS_UNSUCCESSFUL;</span><br><span class="line">		<span class="keyword">return</span> status;</span><br><span class="line">	&#125;</span><br><span class="line">	*next = topdev;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置这个设备已经启动。</span></span><br><span class="line">	(*fltobj)-&gt;Flags = (*fltobj)-&gt;Flags &amp; ~DO_DEVICE_INITIALIZING;</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这个函数绑定所有的串口。</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ccpAttachAllComs</span><span class="params">(PDRIVER_OBJECT driver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ULONG i;</span><br><span class="line">	PDEVICE_OBJECT com_ob;</span><br><span class="line">	NTSTATUS status;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; CCP_MAX_COM_ID; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 获得object引用。</span></span><br><span class="line">		com_ob = ccpOpenCom(i, &amp;status);</span><br><span class="line">		<span class="keyword">if</span> (com_ob == <span class="literal">NULL</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="comment">// 在这里绑定。并不管绑定是否成功。</span></span><br><span class="line">		ccpAttachDevice(driver, com_ob, &amp;s_fltobj[i], &amp;s_nextobj[i]);</span><br><span class="line">		<span class="comment">// 取消object引用。</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  DELAY_ONE_MICROSECOND  (-10)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  DELAY_ONE_MILLISECOND (DELAY_ONE_MICROSECOND*1000)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>  DELAY_ONE_SECOND (DELAY_ONE_MILLISECOND*1000)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ccpUnload</span><span class="params">(PDRIVER_OBJECT drv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ULONG i;</span><br><span class="line">	LARGE_INTEGER interval;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 首先解除绑定</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; CCP_MAX_COM_ID; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (s_nextobj[i] != <span class="literal">NULL</span>)</span><br><span class="line">			IoDetachDevice(s_nextobj[i]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 睡眠5秒。等待所有irp处理结束</span></span><br><span class="line">	interval.QuadPart = (<span class="number">5</span> * <span class="number">1000</span> * DELAY_ONE_MILLISECOND);</span><br><span class="line">	KeDelayExecutionThread(KernelMode, FALSE, &amp;interval);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 删除这些设备</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; CCP_MAX_COM_ID; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (s_fltobj[i] != <span class="literal">NULL</span>)</span><br><span class="line">			IoDeleteDevice(s_fltobj[i]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">ccpDispatch</span><span class="params">(PDEVICE_OBJECT device, PIRP irp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	PIO_STACK_LOCATION irpsp = IoGetCurrentIrpStackLocation(irp);</span><br><span class="line">	NTSTATUS status;</span><br><span class="line">	ULONG i, j;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 首先得知道发送给了哪个设备。设备一共最多CCP_MAX_COM_ID</span></span><br><span class="line">	<span class="comment">// 个，是前面的代码保存好的，都在s_fltobj中。</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; CCP_MAX_COM_ID; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (s_fltobj[i] == device)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// 所有电源操作，全部直接放过。</span></span><br><span class="line">			<span class="keyword">if</span> (irpsp-&gt;MajorFunction == IRP_MJ_POWER)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// 直接发送，然后返回说已经被处理了。</span></span><br><span class="line">				PoStartNextPowerIrp(irp);</span><br><span class="line">				IoSkipCurrentIrpStackLocation(irp);</span><br><span class="line">				<span class="keyword">return</span> PoCallDriver(s_nextobj[i], irp);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 此外我们只过滤写请求。写请求的话，获得缓冲区以及其长度。</span></span><br><span class="line">			<span class="comment">// 然后打印一下。</span></span><br><span class="line">			<span class="keyword">if</span> (irpsp-&gt;MajorFunction == IRP_MJ_WRITE)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">// 如果是写，先获得长度</span></span><br><span class="line">				ULONG len = irpsp-&gt;Parameters.Write.Length;</span><br><span class="line">				<span class="comment">// 然后获得缓冲区</span></span><br><span class="line">				PUCHAR buf = <span class="literal">NULL</span>;</span><br><span class="line">				<span class="keyword">if</span> (irp-&gt;MdlAddress != <span class="literal">NULL</span>)</span><br><span class="line">					buf =</span><br><span class="line">					(PUCHAR)</span><br><span class="line">					MmGetSystemAddressForMdlSafe(irp-&gt;MdlAddress, NormalPagePriority);</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					buf = (PUCHAR)irp-&gt;UserBuffer;</span><br><span class="line">				<span class="keyword">if</span> (buf == <span class="literal">NULL</span>)</span><br><span class="line">					buf = (PUCHAR)irp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 打印内容</span></span><br><span class="line">				<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; len; ++j)</span><br><span class="line">				&#123;</span><br><span class="line">					DbgPrint(<span class="string">&quot;comcap: Send Data: %2x\r\n&quot;</span>,</span><br><span class="line">						buf[j]);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 这些请求直接下发执行即可。我们并不禁止或者改变它。</span></span><br><span class="line">			IoSkipCurrentIrpStackLocation(irp);</span><br><span class="line">			<span class="keyword">return</span> IoCallDriver(s_nextobj[i], irp);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果根本就不在被绑定的设备中，那是有问题的，直接返回参数错误。</span></span><br><span class="line">	irp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">	irp-&gt;IoStatus.Status = STATUS_INVALID_PARAMETER;</span><br><span class="line">	IoCompleteRequest(irp, IO_NO_INCREMENT);</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT driver, PUNICODE_STRING reg_path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> i;</span><br><span class="line">	<span class="comment">// 所有的分发函数都设置成一样的。</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; IRP_MJ_MAXIMUM_FUNCTION; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		driver-&gt;MajorFunction[i] = ccpDispatch;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 支持动态卸载。</span></span><br><span class="line">	driver-&gt;DriverUnload = ccpUnload;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 绑定所有的串口。</span></span><br><span class="line">	ccpAttachAllComs(driver);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 直接返回成功即可。</span></span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&quot;ntddk.h&quot;</span></span></span><br><span class="line"><span class="function">VOID <span class="title">xiezai1</span><span class="params">(PDRIVER_OBJECT qudongduixiang_wode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	KdPrint((<span class="string">&quot;驱动卸载历程 已经执行\n&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">HANDLE <span class="title">chuanjianzhucebiao_xiang</span><span class="params">(<span class="keyword">wchar_t</span>* zhucebiaoxiang_lujing)</span> <span class="comment">//ZwCreateKey</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE jubing;<span class="comment">//创建注册表项的句柄</span></span><br><span class="line">	OBJECT_ATTRIBUTES shuxing_duixiang;</span><br><span class="line">	UNICODE_STRING zhucebiaoxiangmingzi;<span class="comment">//注册表项的名字也就是路径</span></span><br><span class="line">	ULONG fanhui1;<span class="comment">//创建一个新的项 或是现有的键被打开了</span></span><br><span class="line">	RtlInitUnicodeString(&amp;zhucebiaoxiangmingzi, zhucebiaoxiang_lujing);</span><br><span class="line">	InitializeObjectAttributes(&amp;shuxing_duixiang, &amp;zhucebiaoxiangmingzi, OBJ_CASE_INSENSITIVE, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	ZwCreateKey(&amp;jubing, GENERIC_ALL, &amp;shuxing_duixiang, <span class="number">0</span>, &amp;zhucebiaoxiangmingzi, REG_OPTION_NON_VOLATILE, &amp;fanhui1);</span><br><span class="line">	<span class="keyword">if</span> (fanhui1 == REG_CREATED_NEW_KEY)</span><br><span class="line">	&#123;</span><br><span class="line">		KdPrint((<span class="string">&quot;创建一个新的密钥\n&quot;</span>));</span><br><span class="line">	&#125;<span class="keyword">if</span> (fanhui1 == REG_OPENED_EXISTING_KEY)</span><br><span class="line">	&#123;</span><br><span class="line">		KdPrint((<span class="string">&quot;现有的键被打开了\n&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> jubing;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">HANDLE <span class="title">dakaizhucebiao_xiang</span><span class="params">(<span class="keyword">wchar_t</span>* zhucebiaoxiang_lujing)</span><span class="comment">//ZwOpenKey</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE jubing;<span class="comment">//创建注册表项的句柄</span></span><br><span class="line">	UNICODE_STRING zhucebiaoxiangmingzi;<span class="comment">//注册表项的名字也就是路径</span></span><br><span class="line">	OBJECT_ATTRIBUTES shuxing_duixiang;</span><br><span class="line">	NTSTATUS zhuangtai1;</span><br><span class="line">	RtlInitUnicodeString(&amp;zhucebiaoxiangmingzi, zhucebiaoxiang_lujing);</span><br><span class="line">	InitializeObjectAttributes(&amp;shuxing_duixiang, &amp;zhucebiaoxiangmingzi, OBJ_CASE_INSENSITIVE, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	zhuangtai1 = ZwOpenKey(&amp;jubing, GENERIC_ALL, &amp;shuxing_duixiang);</span><br><span class="line">	<span class="keyword">if</span> (zhuangtai1 == STATUS_SUCCESS)</span><br><span class="line">	&#123;</span><br><span class="line">		KdPrint((<span class="string">&quot;注册表_项 打开成功\n&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span> jubing;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		KdPrint((<span class="string">&quot;注册表_项 打开失败\n&quot;</span>));</span><br><span class="line">		<span class="keyword">return</span> jubing;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> jubing;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">VOID <span class="title">shezhixiangdejiandezhi</span><span class="params">(HANDLE jubing)</span><span class="comment">//设置项的键的值 ZwSetValueKey</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	NTSTATUS zhuangtai1;</span><br><span class="line">	ULONG jiandezhi = <span class="number">100</span>;</span><br><span class="line">	UNICODE_STRING jiandemingzi;</span><br><span class="line">	RtlInitUnicodeString(&amp;jiandemingzi, <span class="string">L&quot;m_1&quot;</span>);</span><br><span class="line">	zhuangtai1 = ZwSetValueKey(jubing, &amp;jiandemingzi, <span class="number">0</span>, REG_DWORD, &amp;jiandezhi, <span class="keyword">sizeof</span>(jiandezhi));</span><br><span class="line">	<span class="keyword">if</span> (!NT_SUCCESS(zhuangtai1))</span><br><span class="line">	&#123;</span><br><span class="line">		KdPrint((<span class="string">&quot;设置键值失败\n&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		KdPrint((<span class="string">&quot;设置键值成功\n&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT qudongduixiang_wode, PUNICODE_STRING zhucebiao_wode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	KdPrint((<span class="string">&quot;打印本驱动的注册表路径%wZ\n&quot;</span>, zhucebiao_wode));</span><br><span class="line">	HANDLE jubing = <span class="literal">NULL</span>;</span><br><span class="line">	ULONG xiang_geshu = <span class="number">0</span>;</span><br><span class="line">	jubing = chuanjianzhucebiao_xiang(<span class="string">L&quot;\\HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run&quot;</span>);<span class="comment">//创建注册表项</span></span><br><span class="line">	jubing = dakaizhucebiao_xiang(<span class="string">L&quot;\\HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run&quot;</span>);<span class="comment">//打开注册表项</span></span><br><span class="line">	shezhixiangdejiandezhi(jubing);<span class="comment">//设置项的键的值</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//ZwDeleteKey(jubing);删除注册表_项</span></span><br><span class="line">	ZwClose(jubing);</span><br><span class="line">	qudongduixiang_wode-&gt;DriverUnload = xiezai1;</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="键盘的过滤"><a href="#键盘的过滤" class="headerlink" title="键盘的过滤"></a>键盘的过滤</h2><p>这只是单独的读取数据的例子，但是最后的结果还有一些缺陷，虽然可以成功的读取到数据，但是当卸载驱动并关闭应用程序后不重启系统在重新加载驱动和开启应用程序就会报错，而且当在一次卸载时就会蓝屏。至于为什么会出现这样的bug，我也还没有搞清楚。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这是驱动的程序</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_NAME <span class="meta-string">L&quot;\\Device\\MyReadDevice&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYM_LINK_NAME <span class="meta-string">L&quot;\\??\\MyRead&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">Unload</span><span class="params">(PDRIVER_OBJECT driver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    IoDeleteSymbolicLink(&amp;SymLinkName);</span><br><span class="line">	IoDeleteDevice(pDevice);</span><br><span class="line">	DbgPrint(<span class="string">&quot;this driver is unloading..\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverCreate</span><span class="params">(PDEVICE_OBJECT device, PIRP pIrp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	pIrp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">	pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">	IoCompleteRequest(pIrp, IO_NO_INCREMENT);	</span><br><span class="line">	DbgPrint(<span class="string">&quot;create this device success\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverRead</span><span class="params">(PDEVICE_OBJECT device, PIRP pIrp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	NTSTATUS status;</span><br><span class="line">	PIO_STACK_LOCATION <span class="built_in">stack</span> = IoGetCurrentIrpStackLocation(pIrp);</span><br><span class="line">	ULONG ulReadLength = <span class="built_in">stack</span>-&gt;Parameters.Read.Length;</span><br><span class="line">	pIrp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">	pIrp-&gt;IoStatus.Information = ulReadLength;</span><br><span class="line">	<span class="built_in">memset</span>(pIrp-&gt;AssociatedIrp.SystemBuffer, <span class="number">0xAA</span>, ulReadLength);</span><br><span class="line">	IoCompleteRequest(pIrp, IO_NO_INCREMENT);</span><br><span class="line">	DbgPrint(<span class="string">&quot;OVER\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT driver, PUNICODE_STRING reg_path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	driver-&gt;MajorFunction[IRP_MJ_READ] = MyDriverRead;  <span class="comment">//派遣读函数</span></span><br><span class="line">	driver-&gt;MajorFunction[IRP_MJ_CREATE] = MyDriverCreate; <span class="comment">//派遣生成函数</span></span><br><span class="line">	driver-&gt;DriverUnload = Unload;</span><br><span class="line">	PDEVICE_OBJECT pDevice;   <span class="comment">//</span></span><br><span class="line">	UNICODE_STRING DeviceName;</span><br><span class="line">	RtlInitUnicodeString(&amp;DeviceName, DEVICE_NAME);  <span class="comment">//初始化设备的名字 应用层打开一个设备不是使用设备名字打开的，打开设备需要使用符号链接，符号链接相当于给设备起一个起了另外一个名字 , RtlInitUnicodeString的作用是初始化字符串</span></span><br><span class="line">	NTSTATUS status = IoCreateDevice(driver, <span class="number">0</span>, &amp;DeviceName, FILE_DEVICE_UNKNOWN, <span class="number">0</span>, TRUE, &amp;pDevice); <span class="comment">//IoCreateDevice函数用于生成设备</span></span><br><span class="line">	<span class="keyword">if</span> ( !NT_SUCCESS(status))</span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;Create Device Failed!!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;Create Device success!!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	UNICODE_STRING SymLinkName = RTL_CONSTANT_STRING(SYM_LINK_NAME);	<span class="comment">//初始化SymLinkName，和RtlInitUnicodeString效果一样 生成符号链接  应用层打开一个设备不是使用设备名字打开的，打开设备需要使用符号链接，符号链接相当于给设备起一个起了另外一个名字，这个名字是暴露给应用层程序的。</span></span><br><span class="line">	status = IoCreateSymbolicLink(&amp;SymLinkName, &amp;DeviceName);</span><br><span class="line">	<span class="keyword">if</span> (!NT_SUCCESS(status))</span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;Create SymbolicLink Failed!!\n&quot;</span>);</span><br><span class="line">		IoDeleteDevice(pDevice);  <span class="comment">//如果符号链接失败的话就删除生成的设备对象</span></span><br><span class="line">		<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;create SymbolicLink success!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	pDevice-&gt;Flags |= DO_BUFFERED_IO;  <span class="comment">//设置符号位  使用缓冲区进行读写</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//这是应用层的程序</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> a;</span><br><span class="line"><span class="keyword">int</span> _tmain(<span class="keyword">int</span> argc,_TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	</span><br><span class="line">	HANDLE hDevice = CreateFile(</span><br><span class="line">		<span class="string">L&quot;\\\\.\\MyRead&quot;</span>,</span><br><span class="line">		GENERIC_READ | GENERIC_WRITE,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		OPEN_EXISTING,</span><br><span class="line">		FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">		);</span><br><span class="line">	<span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Failed to obtain handle to device&quot;</span>);</span><br><span class="line">		scanf_s(<span class="string">&quot;%d&quot;</span>, &amp;a);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	UCHAR buffer[<span class="number">10</span>];   <span class="comment">//定义一个10个字节的缓冲区</span></span><br><span class="line">	ULONG ulRead;   <span class="comment">//定义我们要读多长</span></span><br><span class="line">	BOOL bRet = ReadFile(hDevice, buffer, <span class="number">10</span>, &amp;ulRead, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (bRet)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Read %d bytes:&quot;</span>, ulRead);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (<span class="keyword">int</span>)ulRead; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%02X&quot;</span>, buffer[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		scanf_s(<span class="string">&quot;%d&quot;</span>, &amp;a);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	CloseHandle(hDevice);</span><br><span class="line">	scanf_s(<span class="string">&quot;%d&quot;</span>, &amp;a);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/11/17/pDBNfxd8RZUQ2aV.png" alt="image-20211117201959942"></p>
<p><img src="https://i.loli.net/2021/11/20/YgvF9WrVJMfpK1s.png" alt="image-20211120211245338"></p>
<p><img src="https://i.loli.net/2021/11/20/efS7xwQMRZCnrzU.png" alt="image-20211120211311991"></p>
<p>上面只是单纯的输出的功能，接下来可以尝试着输入和输出一起</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">\\ 驱动程序  这是根据上面单纯输出的程序改的</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IOCTL_TEST1 CTL_CODE(\</span></span><br><span class="line"><span class="meta">	FILE_DEVICE_UNKNOWN, \</span></span><br><span class="line"><span class="meta">	0x800, \</span></span><br><span class="line"><span class="meta">	METHOD_BUFFERED, \</span></span><br><span class="line"><span class="meta">	FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_NAME <span class="meta-string">L&quot;\\Device\\MyReadDevice&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYM_LINK_NAME <span class="meta-string">L&quot;\\??\\MyRead&quot;</span></span></span><br><span class="line">PDEVICE_OBJECT pDevice;</span><br><span class="line">UNICODE_STRING SymLinkName;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">Unload</span><span class="params">(PDRIVER_OBJECT driver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	IoDeleteSymbolicLink(&amp;SymLinkName);</span><br><span class="line">	IoDeleteDevice(pDevice);</span><br><span class="line">	DbgPrint(<span class="string">&quot;this driver is unloading..\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverApi</span><span class="params">(PDEVICE_OBJECT device, PIRP pIrp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	pIrp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">	pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">	IoCompleteRequest(pIrp, IO_NO_INCREMENT);	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverIoctl</span><span class="params">(PDEVICE_OBJECT device, PIRP pIrp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">	PIO_STACK_LOCATION irps = IoGetCurrentIrpStackLocation(pIrp);</span><br><span class="line">	ULONG inlength = irps-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line">	ULONG outlength = irps-&gt;Parameters.DeviceIoControl.OutputBufferLength;</span><br><span class="line">	ULONG CODE = irps-&gt;Parameters.DeviceIoControl.IoControlCode;</span><br><span class="line">	ULONG info = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">switch</span> (CODE)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> IOCTL_TEST1:</span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;enther the IO\n&quot;</span>);</span><br><span class="line">		DbgPrint(<span class="string">&quot;%d&quot;</span>,(<span class="keyword">int</span>)inlength);</span><br><span class="line">		PUCHAR inbuffer = pIrp-&gt;AssociatedIrp.SystemBuffer; </span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; inlength; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			DbgPrint(<span class="string">&quot;%x&quot;</span>, inbuffer[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		PUCHAR outbuffer = pIrp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">		<span class="built_in">memset</span>(outbuffer, <span class="number">0xcc</span>, outlength);</span><br><span class="line">		info = outlength;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		DbgPrint(<span class="string">&quot;error\n&quot;</span>);</span><br><span class="line">		status = STATUS_UNSUCCESSFUL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	pIrp-&gt;IoStatus.Status = status;</span><br><span class="line">	pIrp-&gt;IoStatus.Information = info;</span><br><span class="line">	IoCompleteRequest(pIrp, IO_NO_INCREMENT);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT driver, PUNICODE_STRING reg_path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; IRP_MJ_MAXIMUM_FUNCTION; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		driver-&gt;MajorFunction[i] = MyDriverApi;</span><br><span class="line">	&#125;</span><br><span class="line">	driver-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = MyDriverIoctl;</span><br><span class="line">	driver-&gt;DriverUnload = Unload;</span><br><span class="line">	UNICODE_STRING DeviceName;</span><br><span class="line">	RtlInitUnicodeString(&amp;DeviceName, DEVICE_NAME);  <span class="comment">//初始化设备的名字 应用层打开一个设备不是使用设备名字打开的，打开设备需要使用符号链接，符号链接相当于给设备起一个起了另外一个名字</span></span><br><span class="line">	NTSTATUS status = IoCreateDevice(driver, <span class="number">0</span>, &amp;DeviceName, FILE_DEVICE_UNKNOWN, <span class="number">0</span>, TRUE, &amp;pDevice);</span><br><span class="line">	<span class="keyword">if</span> ( !NT_SUCCESS(status))</span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;Create Device Failed!!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;Create Device success!!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	UNICODE_STRING SymLinkName = RTL_CONSTANT_STRING(SYM_LINK_NAME);	<span class="comment">//初始化SymLinkName，和RtlInitUnicodeString效果一样 生成符号链接 </span></span><br><span class="line">	status = IoCreateSymbolicLink(&amp;SymLinkName, &amp;DeviceName);</span><br><span class="line">	<span class="keyword">if</span> (!NT_SUCCESS(status))</span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;Create SymbolicLink Failed!!\n&quot;</span>);</span><br><span class="line">		IoDeleteDevice(pDevice);</span><br><span class="line">		<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;create SymbolicLink success!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	pDevice-&gt;Flags |= DO_BUFFERED_IO;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">\\ 这是c的程序，也是上面的程序更改而来</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IOCTL_TEST1 CTL_CODE(\</span></span><br><span class="line"><span class="meta">		FILE_DEVICE_UNKNOWN,\</span></span><br><span class="line"><span class="meta">		0x800,\</span></span><br><span class="line"><span class="meta">		METHOD_BUFFERED,\</span></span><br><span class="line"><span class="meta">		FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> a;</span><br><span class="line"><span class="keyword">int</span> _tmain(<span class="keyword">int</span> argc,_TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	</span><br><span class="line">	HANDLE hDevice = CreateFile(</span><br><span class="line">		<span class="string">L&quot;\\\\.\\MyRead&quot;</span>,</span><br><span class="line">		GENERIC_READ | GENERIC_WRITE,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		OPEN_EXISTING,</span><br><span class="line">		FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">		);</span><br><span class="line">	<span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Failed to obtain handle to device&quot;</span>);</span><br><span class="line">		scanf_s(<span class="string">&quot;%d&quot;</span>, &amp;a);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	DWORD dwOutput = <span class="number">0</span>;</span><br><span class="line">	UCHAR InputBuffer[<span class="number">8</span>];  </span><br><span class="line">	UCHAR OutputBuffer[<span class="number">8</span>];</span><br><span class="line">	<span class="built_in">memset</span>(OutputBuffer, <span class="number">0x00</span>, <span class="number">8</span>);</span><br><span class="line">	<span class="built_in">memset</span>(InputBuffer, <span class="number">0xbb</span>, <span class="number">8</span>);</span><br><span class="line">	BOOL bRet;</span><br><span class="line">	bRet = DeviceIoControl(hDevice, IOCTL_TEST1, InputBuffer, <span class="number">8</span>, OutputBuffer, <span class="number">8</span>, &amp;dwOutput, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (bRet)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Output Buffer:%d bytes\n&quot;</span>, dwOutput);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (<span class="keyword">int</span>)dwOutput; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%02X\n&quot;</span>, OutputBuffer[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	CloseHandle(hDevice);</span><br><span class="line">	scanf_s(<span class="string">&quot;%d&quot;</span>, &amp;a);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/11/25/u3n4eEfds5Uz1CR.png" alt="image-20211125211518059"></p>
<p>这是做了一个有点意思的东西，我们输入一个进程ID，可以杀掉这个进程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">\\ 驱动程序</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IOCTL_TEST1 CTL_CODE(\</span></span><br><span class="line"><span class="meta">	FILE_DEVICE_UNKNOWN, \</span></span><br><span class="line"><span class="meta">	0x800, \</span></span><br><span class="line"><span class="meta">	METHOD_BUFFERED, \</span></span><br><span class="line"><span class="meta">	FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_NAME <span class="meta-string">L&quot;\\Device\\MyReadDevice&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SYM_LINK_NAME <span class="meta-string">L&quot;\\??\\MyRead&quot;</span></span></span><br><span class="line">PDEVICE_OBJECT pDevice;</span><br><span class="line">UNICODE_STRING SymLinkName;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">Unload</span><span class="params">(PDRIVER_OBJECT driver)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	IoDeleteSymbolicLink(&amp;SymLinkName);</span><br><span class="line">	IoDeleteDevice(pDevice);</span><br><span class="line">	DbgPrint(<span class="string">&quot;this driver is unloading..\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverApi</span><span class="params">(PDEVICE_OBJECT device, PIRP pIrp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	pIrp-&gt;IoStatus.Status = STATUS_SUCCESS;</span><br><span class="line">	pIrp-&gt;IoStatus.Information = <span class="number">0</span>;</span><br><span class="line">	IoCompleteRequest(pIrp, IO_NO_INCREMENT);	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOLEAN <span class="title">KillProcess</span><span class="params">(LONG pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HANDLE ProcessHandle;</span><br><span class="line">	NTSTATUS status;</span><br><span class="line">	OBJECT_ATTRIBUTES ObjectAttributes;</span><br><span class="line">	CLIENT_ID myCid;</span><br><span class="line">	InitializeObjectAttributes(&amp;ObjectAttributes, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	myCid.UniqueProcess = (HANDLE)pid;</span><br><span class="line">	myCid.UniqueThread = <span class="number">0</span>;</span><br><span class="line">	status = ZwOpenProcess(&amp;ProcessHandle, PROCESS_ALL_ACCESS, &amp;ObjectAttributes, &amp;myCid);</span><br><span class="line">	<span class="keyword">if</span> (NT_SUCCESS(status))</span><br><span class="line">	&#123;</span><br><span class="line">		ZwTerminateProcess(ProcessHandle,status);</span><br><span class="line">		ZwClose(ProcessHandle);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">MyDriverIoctl</span><span class="params">(PDEVICE_OBJECT device, PIRP pIrp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	NTSTATUS status = STATUS_SUCCESS;</span><br><span class="line">	PIO_STACK_LOCATION irps = IoGetCurrentIrpStackLocation(pIrp);</span><br><span class="line">	ULONG inlength = irps-&gt;Parameters.DeviceIoControl.InputBufferLength;</span><br><span class="line">	ULONG outlength = irps-&gt;Parameters.DeviceIoControl.OutputBufferLength;</span><br><span class="line">	ULONG CODE = irps-&gt;Parameters.DeviceIoControl.IoControlCode;</span><br><span class="line">	ULONG info = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">switch</span> (CODE)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> IOCTL_TEST1:</span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;enther the IO\n&quot;</span>);</span><br><span class="line">		DbgPrint(<span class="string">&quot;%d&quot;</span>,(<span class="keyword">int</span>)inlength);</span><br><span class="line">		LONG mypid = *(PLONG)(pIrp-&gt;AssociatedIrp.SystemBuffer);</span><br><span class="line">		DbgPrint(<span class="string">&quot;%d&quot;</span>, mypid);</span><br><span class="line">		BOOLEAN test = KillProcess(mypid);</span><br><span class="line">		<span class="keyword">if</span> (test)</span><br><span class="line">		&#123;</span><br><span class="line">			DbgPrint(<span class="string">&quot;kill process successful\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			DbgPrint(<span class="string">&quot;kill process error\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		PUCHAR outbuffer = pIrp-&gt;AssociatedIrp.SystemBuffer;</span><br><span class="line">		<span class="built_in">memset</span>(outbuffer, <span class="number">0xcc</span>, outlength);</span><br><span class="line">		info = outlength;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		DbgPrint(<span class="string">&quot;error\n&quot;</span>);</span><br><span class="line">		status = STATUS_UNSUCCESSFUL;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	pIrp-&gt;IoStatus.Status = status;</span><br><span class="line">	pIrp-&gt;IoStatus.Information = info;</span><br><span class="line">	IoCompleteRequest(pIrp, IO_NO_INCREMENT);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NTSTATUS <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT driver, PUNICODE_STRING reg_path)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; IRP_MJ_MAXIMUM_FUNCTION; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		driver-&gt;MajorFunction[i] = MyDriverApi;</span><br><span class="line">	&#125;</span><br><span class="line">	driver-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL] = MyDriverIoctl;</span><br><span class="line">	driver-&gt;DriverUnload = Unload;</span><br><span class="line">	UNICODE_STRING DeviceName;</span><br><span class="line">	RtlInitUnicodeString(&amp;DeviceName, DEVICE_NAME);  <span class="comment">//初始化设备的名字 应用层打开一个设备不是使用设备名字打开的，打开设备需要使用符号链接，符号链接相当于给设备起一个起了另外一个名字</span></span><br><span class="line">	NTSTATUS status = IoCreateDevice(driver, <span class="number">0</span>, &amp;DeviceName, FILE_DEVICE_UNKNOWN, <span class="number">0</span>, TRUE, &amp;pDevice);</span><br><span class="line">	<span class="keyword">if</span> ( !NT_SUCCESS(status))</span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;Create Device Failed!!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;Create Device success!!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	UNICODE_STRING SymLinkName = RTL_CONSTANT_STRING(SYM_LINK_NAME);	<span class="comment">//初始化SymLinkName，和RtlInitUnicodeString效果一样 生成符号链接 </span></span><br><span class="line">	status = IoCreateSymbolicLink(&amp;SymLinkName, &amp;DeviceName);</span><br><span class="line">	<span class="keyword">if</span> (!NT_SUCCESS(status))</span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;Create SymbolicLink Failed!!\n&quot;</span>);</span><br><span class="line">		IoDeleteDevice(pDevice);</span><br><span class="line">		<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		DbgPrint(<span class="string">&quot;create SymbolicLink success!&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	pDevice-&gt;Flags |= DO_BUFFERED_IO;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">\\ c程序</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IOCTL_TEST1 CTL_CODE(\</span></span><br><span class="line"><span class="meta">		FILE_DEVICE_UNKNOWN,\</span></span><br><span class="line"><span class="meta">		0x800,\</span></span><br><span class="line"><span class="meta">		METHOD_BUFFERED,\</span></span><br><span class="line"><span class="meta">		FILE_ANY_ACCESS)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> a;</span><br><span class="line"><span class="keyword">int</span> _tmain(<span class="keyword">int</span> argc,_TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	</span><br><span class="line">	HANDLE hDevice = CreateFile(</span><br><span class="line">		<span class="string">L&quot;\\\\.\\MyRead&quot;</span>,</span><br><span class="line">		GENERIC_READ | GENERIC_WRITE,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		OPEN_EXISTING,</span><br><span class="line">		FILE_ATTRIBUTE_NORMAL,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">		);</span><br><span class="line">	<span class="keyword">if</span> (hDevice == INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Failed to obtain handle to device&quot;</span>);</span><br><span class="line">		scanf_s(<span class="string">&quot;%d&quot;</span>, &amp;a);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	DWORD dwOutput = <span class="number">0</span>;</span><br><span class="line">	UCHAR InputBuffer[<span class="number">8</span>];</span><br><span class="line">	UCHAR OutputBuffer[<span class="number">8</span>];</span><br><span class="line">	<span class="built_in">memset</span>(OutputBuffer, <span class="number">0x00</span>, <span class="number">8</span>);</span><br><span class="line">	<span class="built_in">memset</span>(InputBuffer, <span class="number">0xbb</span>, <span class="number">8</span>);</span><br><span class="line">	<span class="keyword">long</span> pid = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;please enter the process pid\n&quot;</span>);</span><br><span class="line">	scanf_s(<span class="string">&quot;%d&quot;</span>, &amp;pid);</span><br><span class="line">	BOOL bRet;</span><br><span class="line">	bRet = DeviceIoControl(hDevice, IOCTL_TEST1, &amp;pid, <span class="number">4</span>, OutputBuffer, <span class="number">8</span>, &amp;dwOutput, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (bRet)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Output Buffer:%d bytes\n&quot;</span>, dwOutput);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (<span class="keyword">int</span>)dwOutput; i++)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%02X\n&quot;</span>, OutputBuffer[i]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	CloseHandle(hDevice);</span><br><span class="line">	scanf_s(<span class="string">&quot;%d&quot;</span>, &amp;a);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/11/25/7SaZtxCgNnO4cyp.png" alt="image-20211125221541006"></p>
<p><img src="https://i.loli.net/2021/11/25/RP8pDgWXC5HrFqT.png" alt="image-20211125221609121"></p>
<p><img src="https://i.loli.net/2021/11/27/zdUXSCHE6WDoOLq.png" alt="image-20211127173523950"></p>
<p>这个还是这样明明在卸载函数已经把符号链接删除了，但是重新加载驱动，重新生成符号链接就还是会失败。因为符号链接生成失败，所以重新加载的时候会报错，就会直接蓝屏。</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/08/11/C%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0/C%E8%AF%AD%E8%A8%80%E5%AD%A6%E4%B9%A0/" rel="prev" title="C语言学习">
      <i class="fa fa-chevron-left"></i> C语言学习
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E8%AF%91%E9%A9%B1%E5%8A%A8%E6%97%B6%E7%9A%84%E6%AD%A5%E9%AA%A4"><span class="nav-number">1.</span> <span class="nav-text">编译驱动时的步骤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E8%A1%A8"><span class="nav-number">2.</span> <span class="nav-text">注册表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C"><span class="nav-number">3.</span> <span class="nav-text">文件操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E4%B8%8E%E4%BA%8B%E4%BB%B6"><span class="nav-number">4.</span> <span class="nav-text">线程与事件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%B2%E5%8F%A3%E7%9A%84%E8%BF%87%E6%BB%A4"><span class="nav-number">5.</span> <span class="nav-text">串口的过滤</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%AE%E7%9B%98%E7%9A%84%E8%BF%87%E6%BB%A4"><span class="nav-number">6.</span> <span class="nav-text">键盘的过滤</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">nan-del</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">28</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">nan-del</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
